#!/usr/sbin/nft -f

# =============================================================
# nftables-konfiguration för lastbalansering
# =============================================================
#
# TODO: Skapa regler som uppfyller följande krav:
#
# 1. NAT-TABELL (table ip nat)
#    - Prerouting-kedja: Omdirigera trafik på port 80 till
#      applikationsservrarna (172.20.0.11 och 172.20.0.12)
#      på port 5000, med round-robin-fördelning.
#      Tips: Undersök "numgen" och "dnat to ... map" i nftables.
#
#    - Postrouting-kedja: Använd masquerade så att
#      returtrafiken går tillbaka genom lastbalanseraren.
#
# 2. FILTER-TABELL (table ip filter)
#    - Forward-kedja: Begränsa vidarebefordrad trafik.
#      Sätt policy till drop, tillåt etablerade/relaterade
#      anslutningar, och tillåt ny trafik till port 5000.
#
# =============================================================

flush ruleset

# =============================================================
# NAT-TABELL
# =============================================================
table ip nat {
    # Prerouting: Round-robin lastbalansering till app1 och app2
    chain prerouting {
        type nat hook prerouting priority dstnat; policy accept;
        
        # Lastbalansera trafik på port 80 mellan de två appservrarna
        tcp dport 80 dnat to numgen inc mod 2 map { \
            0 : 172.20.0.11, \
            1 : 172.20.0.12 \
        }:5000
    }

    # Postrouting: Masquerade för returtrafik
    chain postrouting {
        type nat hook postrouting priority srcnat; policy accept;
        masquerade
    }
}

# =============================================================
# FILTER-TABELL
# =============================================================
table ip filter {
    # Forward: Säkerhetskontroll för vidarebefordrad trafik
    chain forward {
        type filter hook forward priority filter; policy drop;
        
        # Tillåt etablerade och relaterade anslutningar
        ct state established,related accept
        
        # Tillåt ny trafik till port 5000 (applikationsservrarna)
        tcp dport 5000 ct state new accept
    }
}
